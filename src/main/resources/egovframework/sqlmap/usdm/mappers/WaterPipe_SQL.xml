<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.usdm.service.impl.WaterPipeMapper">

	<resultMap id="waterPipeAccident" type="egovframework.usdm.service.WaterPipeAccidentVO">
		<result property="pipeFtrCde" column="pipeFtrCde"/>
		<result property="pipeFtrIdn" column="pipeFtrIdn"/>
		<result property="longitude" column="longitude"/>
		<result property="latitude" column="latitude"/>
		<result property="accidentTime" column="accidentTime"/>
		<result property="accidentType" column="accidentType"/>
		<result property="accidentShape" column="accidentShape"/>
		<result property="accidentDesc" column="accidentDesc"/>
	</resultMap>

	<select id="selectWaterPipeGeometry" resultType="EgovMap">
		<![CDATA[
			SELECT ftr_idn   AS id
				 , wgscoords AS geom
				 , SUBSTR(ST_ASTEXT(geom),12,LENGTH(ST_ASTEXT(geom))-12) AS tmgeom
			  FROM sdm_WaterPipe
		]]>
	</select>
	
	<insert id="insertWaterAccident" parameterType="waterPipeAccidentVO">
		<![CDATA[
			INSERT INTO sdm_WaterAccident (
						pipe_ftr_cde
					  , pipe_ftr_idn
					  , longitude
					  , latitude
					  , coordinate
					  , accidentTime
					  , accidentType
					  , accidentShape
					  , accidentDesc
					  )
				VALUES (
					    (SELECT ftr_cde FROM sdm_WaterPipe WHERE ftr_idn = #{pipeFtrIdn})
					  , #{pipeFtrIdn}
					  , #{longitude}
					  , #{latitude}
					  , ST_POINTFROMTEXT('POINT(${x} ${y})',0)
					  , #{accidentTime}
					  , #{accidentType}
					  , #{accidentShape}
					  , #{accidentDesc}
					  )
		]]>
	</insert>
	
	<select id="selectWaterAccidentList" parameterType="usdmSearchVO" resultType="egovMap">
		<![CDATA[
			SELECT pipe_ftr_cde
			     , pipe_ftr_idn
			     , longitude
			     , latitude
			     , TO_CHAR(accidentTime) AS accidentTime
			     , accidentTime AS accidentTimeLong
			     , accidentType
			     , accidentShape
			  FROM sdm_WaterAccident
			 WHERE ('' = #{ftrIdn} OR pipe_ftr_idn = #{ftrIdn})
			   ${spatialCondition}
		  ORDER BY accidentTimeLong DESC
		]]>
	</select>
	
	<select id="selectWaterAccidentDetail" parameterType="waterPipeAccidentVO" resultType="waterPipeAccidentVO">
		<![CDATA[
			SELECT pipe_ftr_cde AS pipeFtrCde
			     , pipe_ftr_idn AS pipeFtrIdn
			     , longitude
			     , latitude
			     , accidentTime
			     , accidentType
			     , accidentShape
			     , accidentDesc
			  FROM sdm_WaterAccident
			 WHERE pipe_ftr_cde = #{pipeFtrCde}
			   AND pipe_ftr_idn = #{pipeFtrIdn}
			   AND longitude    = #{longitude}
			   AND latitude     = #{latitude}
			   AND accidentTime = #{accidentTime}
		]]>
	</select>

</mapper>